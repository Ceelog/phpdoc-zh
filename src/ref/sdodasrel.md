预定义类
--------

The Relational DAS provides two classes: the Relational DAS itself and
the subclass of Exception that can be thrown. The Relational DAS has
four publicly useful calls: the constructor, the <span
class="function">createRootDataObject</span> call to obtain the root
object of an empty data graph, the <span
class="function">executeQuery</span> call to obtain a data graph
containing data from a relational database, and the <span
class="function">applyChanges</span> call to write changes made to a
data graph back to the relational database.

<span class="classname">SDO\_DAS\_Relational</span>
---------------------------------------------------

The only object other than an SDO\_DAS\_Relational\_Exception with which
the application is expected to interact.

方法
----

-   <a href="/ref/sdodasrel.html#SDO_DAS_Relational::__construct" class="link">__construct</a> -
    construct the Relational DAS with a model derived from the passed
    metadata

-   <a href="/ref/sdodasrel.html#SDO_DAS_Relational::createRootDataObject" class="link">createRootDataObject</a> -
    obtain an otherwise empty data graph containing just the special
    root object

-   <a href="/ref/sdodasrel.html#SDO_DAS_Relational::executeQuery" class="link">executeQuery</a> -
    execute an SQL query passed as a literal string and return the
    results as a normalised data graph

-   <a href="/ref/sdodasrel.html#SDO_DAS_Relational::executePreparedQuery" class="link">executePreparedQuery</a> -
    execute an SQL query passed as a prepared statement, with a list of
    values to substitute for placeholders, and return the results as a
    normalised data graph

-   <a href="/ref/sdodasrel.html#SDO_DAS_Relational::applyChanges" class="link">applyChanges</a> -
    examine the change summary in the data graph and apply those changes
    back to the database, subject to an assumption of optimistic
    concurrency

<span class="classname">SDO\_DAS\_Relational\_Exception</span>
--------------------------------------------------------------

Is a subclass of PHP's <span class="classname">Exception</span>. It adds
no behaviour to <span class="classname">Exception</span>. Thrown, with
useful descriptive text, to signal errors in the metadata or unexpected
failures to perform SQL operations.

SDO\_DAS\_Relational::applyChanges
==================================

Applies the changes made to a data graph back to the database

### 说明

<span class="type">void</span> <span
class="methodname">SDO\_DAS\_Relational::applyChanges</span> ( <span
class="methodparam"> <span class="type">PDO</span> `$database_handle`
</span> , <span class="methodparam"> <span
class="type">SDODataObject</span> `$root_data_object` </span> )

**Warning**

此函数是*实验性*的。此函数的表象，包括名称及其相关文档都可能在未来的 PHP
发布版本中未通知就被修改。使用本函数风险自担。

Given a PDO database handle and the special root object of a data graph,
examine the change summary in the datagraph and applies the changes to
the database. The changes that it can apply can be creations of data
objects, deletes of data objects, and modifications to properties of
data objects.

### 参数

PDO\_database\_handle  
Constructed using the PDO extension. A typical line to construct a PDO
database handle might look like this:

``` php
$dbh = new PDO("mysql:dbname=COMPANYDB;host=localhost",DATABASE_USER,DATABASE_PASSWORD);
```

root\_data\_object  
The special root object which is at the top of every SDO data graph.

### 返回值

None. Note however that the datagraph that was passed is still intact
and usable. Furthermore, if data objects were created and written back
to a table with autogenerated primary keys, then those primary keys will
now be set in the data objects. If the changes were successfully
written, then the change summary associated with the datagraph will have
been cleared, so that it is possible to now make further changes to the
data graph and apply those changes in turn. In this way it is possible
to work with the same data graph and apply changes repeatedly.

### 错误／异常

<span class="function">SDO\_DAS\_Relational::applyChanges</span> can
throw an <span class="classname">SDO\_DAS\_Relational\_Exception</span>
if it is unable to apply all the changes correctly.

The Relational DAS starts a database transaction before beginning to
apply the changes and will commit the transaction only if they are all
successful. The Relational DAS generates qualified update and delete
statements which contain a where clause that specifies that the row to
be updated or deleted must contain the same values that it did when the
data was first retrieved. This is how the optimistic concurrency is
implemented. If any of the qualified update or delete statements fails
to update or delete their target row, it may be because the data has
been altered in the database in the meantime. In any event, if any
update fails for any reason, the transaction is rolled back and an
exception thrown. The exception will contain the generated SQL statement
that failed.

The Relational DAS also catches any PDO exceptions and obtains PDO
diagnostic information which it includes in an <span
class="classname">SDO\_DAS\_Relational\_Exception</span> which it then
throws.

### 范例

Please see the
<a href="/sdodasrel/examples.html" class="link">Examples</a> section in
the general information about the Relational DAS for many examples of
calling this method. Please see also the section on
<a href="/sdodasrel/setup.html#Tracing" class="link">Tracing</a> to see
how you can see what SQL statements are generated by the Relational DAS.

SDO\_DAS\_Relational::\_\_construct
===================================

Creates an instance of a Relational Data Access Service

### 说明

<span class="methodname">SDO\_DAS\_Relational::\_\_construct</span> (
<span class="methodparam"> <span class="type">array</span>
`$database_metadata` </span> \[, <span class="methodparam"> <span
class="type">string</span> `$application_root_type` </span> \[, <span
class="methodparam"> <span class="type">array</span>
`$SDO_containment_references_metadata` </span> \]\] )

**Warning**

此函数是*实验性*的。此函数的表象，包括名称及其相关文档都可能在未来的 PHP
发布版本中未通知就被修改。使用本函数风险自担。

Constructs an instance of a Relational Data Access Service from the
passed metadata.

### 参数

database\_metadata  
An array containing one or more table definitions, each of which is an
associative array containing the keys `name`, `columns`, `PK`, and
optionally, `FK`. For a full discussion of the metadata, see the
<a href="/sdodasrel/examples.html#Specifying%20the%20metadata" class="link">metadata</a>
section in the general information about the Relational DAS.

application\_root\_type  
The root of each data graph is an object of a special root type and the
application data objects come below that. Of the various application
types in the SDO model, one has to be the application type immediately
below the root of the data graph. If there is only one table in the
database metadata, so the application root type can be inferred, this
argument can be omitted.

SDO\_containment\_references\_metadata  
An array containing one or more definitions of a containment relation,
each of which is an associative array containing the keys `parent` and
`child`. The containment relations describe how the types in the model
are connected to form a tree. The type specified as the application root
type must be present as one of the parent types in the containment
references. If the application only needs to work with one table at a
time, and there are no containment relations in the model, this argument
can be omitted. For a full discussion of the metadata, see the
<a href="/sdodasrel/examples.html#Specifying%20the%20metadata" class="link">metadata</a>
section in the general information about the Relational DAS.

### 返回值

Returns an SDO\_DAS\_Relational object on success.

### 错误／异常

<span class="function">SDO\_DAS\_Relational::\_\_construct</span> throws
a <span class="classname">SDO\_DAS\_Relational\_Exception</span> if any
problems are found in the metadata.

### 范例

For a full discussion of the metadata, see the
<a href="/sdodasrel/examples.html#Specifying%20the%20metadata" class="link">metadata</a>
section in the general information about the Relational DAS.

SDO\_DAS\_Relational::createRootDataObject
==========================================

Returns the special root object in an otherwise empty data graph. Used
when creating a data graph from scratch

### 说明

<span class="type">SDODataObject</span> <span
class="methodname">SDO\_DAS\_Relational::createRootDataObject</span> (
<span class="methodparam">void</span> )

**Warning**

此函数是*实验性*的。此函数的表象，包括名称及其相关文档都可能在未来的 PHP
发布版本中未通知就被修改。使用本函数风险自担。

Returns the special root object at the top of an otherwise empty data
graph. This call is used when the application wants to create a data
graph from scratch, without having called <span
class="function">executeQuery</span> to create a data graph.

The special root object has one multi-valued containment property, with
a name of the application root type that was passed when the Relational
DAS was constructed. The property can take values of only that type. The
only thing that the application can usefully do with the root type is to
call <span class="function">createDataObject</span> on it, passing the
name of the application root type, in order to create a data object of
their own application type.

### 参数

None.

### 返回值

The root object.

### 错误／异常

None.

### 范例

Please see the
<a href="/sdodasrel/examples.html" class="link">Examples</a> section in
the general information about the Relational DAS for many examples of
calling this method.

SDO\_DAS\_Relational::executePreparedQuery
==========================================

Executes an SQL query passed as a prepared statement, with a list of
values to substitute for placeholders, and return the results as a
normalised data graph

### 说明

<span class="type">SDODataObject</span> <span
class="methodname">SDO\_DAS\_Relational::executePreparedQuery</span> (
<span class="methodparam"> <span class="type">PDO</span>
`$database_handle` </span> , <span class="methodparam"> <span
class="type">PDOStatement</span> `$prepared_statement` </span> , <span
class="methodparam"> <span class="type">array</span> `$value_list`
</span> \[, <span class="methodparam"> <span class="type">array</span>
`$column_specifier` </span> \] )

**Warning**

此函数是*实验性*的。此函数的表象，包括名称及其相关文档都可能在未来的 PHP
发布版本中未通知就被修改。使用本函数风险自担。

Executes a given query against the relational database, using the
supplied PDO database handle. Differs from the simpler <span
class="function">executeQuery</span> in that it takes a prepared
statement and a list of values. This is the appropriate call to use
either when the statement is to executed a number of times with
different arguments, and there is therefore a performance benefit to be
had from preparing the statement only once, or when the SQL statement is
to contain varying values taken from a source that cannot be completely
trusted. In this latter case it may be unsafe to construct the SQL
statement by simply concatenating the parts of the statement together,
since the values may contain pieces of SQL. To guard against this, a
so-called SQL injection attack, it is safer to prepare the SQL statement
with placeholders (also known as parameter markers, denoted by '?') and
supply a list of the values to be substituted as a separate argument.
Otherwise this function is the same as <span
class="function">executeQuery</span> in that it uses the model that it
built from the metadata to interpret the result set and returns a data
graph.

### 参数

PDO\_database\_handle  
Constructed using the PDO extension. A typical line to construct a PDO
database handle might look like this:

``` php
$dbh = new PDO("mysql:dbname=COMPANYDB;host=localhost",DATABASE_USER,DATABASE_PASSWORD);
```

prepared\_statement  
A prepared SQL statement to be executed against the database. This will
have been prepared by PDO's <span class="function">prepare</span>
method.

value\_list  
An array of the values to be substituted into the SQL statement in place
of the placeholders. In the event that there are no placeholders or
parameter markers in the SQL statement then this argument can be
specified as **`NULL`** or as an empty array;

column\_specifier  
The Relational DAS needs to examine the result set and for every column,
know which table and which column of that table it came from. In some
circumstances it can find this information for itself, but sometimes it
cannot. In these cases a column specifier is needed, which is an array
that identifies the columns. Each entry in the array is simply a string
in the form `table-name.column_name`.

The column specifier is needed when there are duplicate column names in
the database metadata, For example, in the database used within the
examples, all the tables have both a `id` and a `name` column. When the
Relational DAS fetches the result set from PDO it can do so with the
PDO\_FETCH\_ASSOC attribute, which will cause the columns in the results
set to be labelled with the column name, but will not distinguish
duplicates. So this will only work when there are no duplicates possible
in the results set.

To summarise, specify a column specifier array whenever there is any
uncertainty about which column could be from which table and only omit
it when every column name in the database metadata is unique.

All of the examples in the
<a href="/sdodasrel/examples.html" class="link">Examples</a> use a
column specifier. There is one example in the `Scenarios` directory of
the installation that does not: that which works with just the employee
table, and because it works with just one table, there can not exist
duplicate column names.

### 返回值

Returns a data graph. Specifically, it returns a root object of a
special type. Under this root object will be the data from the result
set. The root object will have a multi-valued containment property with
the same name as the application root type specified on the constructor,
and that property will contain one or more data objects of the
application root type.

In the event that the query returns no data, the special root object
will still be returned but the containment property for the application
root type will be empty.

### 错误／异常

<span class="function">SDO\_DAS\_Relational::executePreparedQuery</span>
can throw an <span
class="classname">SDO\_DAS\_Relational\_Exception</span> if it is unable
to construct the data graph correctly. This can occur for a number of
reasons: for example if it finds that it does not have primary keys in
the result set for all the objects. It also catches any PDO exceptions
and obtains PDO diagnostic information which it includes in an <span
class="classname">SDO\_DAS\_Relational\_Exception</span> which it then
throws.

### 范例

**示例 \#1 Retrieving a data object using <span
class="function">executePreparedQuery</span>**

In this example a single data object is retrieved from the database - or
possibly more than one if there is more than one company called 'Acme'.
For each company returned, the `name` and `id` properties are echoed.

Other examples of the use of <span
class="function">executePreparedQuery</span> can be found in the example
code supplied in `sdo/DAS/Relational/Scenarios`.

``` php
<?php
require_once 'SDO/DAS/Relational.php';
require_once 'company_metadata.inc.php';

/**************************************************************
 * Construct the DAS with the metadata
 ***************************************************************/
$das = new SDO_DAS_Relational ($database_metadata,'company',$SDO_reference_metadata);

/**************************************************************
 * Get a database connection
 ***************************************************************/
$dbh = new PDO(PDO_DSN,DATABASE_USER,DATABASE_PASSWORD);

/**************************************************************
 * Issue a query to obtain a company object - possibly more if they exist
 * Use a prepared query with a placeholder.
 ***************************************************************/
$name = 'Acme';
$pdo_stmt = $dbh->prepare('select name, id from company where name=?');
$root = $das->executePreparedQuery(
    $dbh, 
    $pdo_stmt,
    array($name), 
    array('company.name', 'company.id'));

/**************************************************************
 * Echo name and id 
 ***************************************************************/
foreach ($root['company'] as $company) {
    echo "Company obtained from the database has name = " . 
    $company['name'] . " and id " . $company['id'] . "\n";
}
?>
```

SDO\_DAS\_Relational::executeQuery
==================================

Executes a given SQL query against a relational database and returns the
results as a normalised data graph

### 说明

<span class="type">SDODataObject</span> <span
class="methodname">SDO\_DAS\_Relational::executeQuery</span> ( <span
class="methodparam"> <span class="type">PDO</span> `$database_handle`
</span> , <span class="methodparam"> <span class="type">string</span>
`$SQL_statement` </span> \[, <span class="methodparam"> <span
class="type">array</span> `$column_specifier` </span> \] )

**Warning**

此函数是*实验性*的。此函数的表象，包括名称及其相关文档都可能在未来的 PHP
发布版本中未通知就被修改。使用本函数风险自担。

Executes a given query against the relational database, using the
supplied PDO database handle. Uses the model that it built from the
metadata to interpret the result set. Returns a data graph.

### 参数

PDO\_database\_handle  
Constructed using the PDO extension. A typical line to construct a PDO
database handle might look like this:

``` php
$dbh = new PDO("mysql:dbname=COMPANYDB;host=localhost",DATABASE_USER,DATABASE_PASSWORD);
```

SQL\_statement  
The SQL statement to be executed against the database.

column\_specifier  
The Relational DAS needs to examine the result set and for every column,
know which table and which column of that table it came from. In some
circumstances it can find this information for itself, but sometimes it
cannot. In these cases a column specifier is needed, which is an array
that identifies the columns. Each entry in the array is simply a string
in the form `table-name.column_name`.

The column specifier is needed when there are duplicate column names in
the database metadata. For example, in the database used within the
examples, all the tables have both a `id` and a `name` column. When the
Relational DAS fetches the result set from PDO it can do so with the
PDO\_FETCH\_ASSOC attribute, which will cause the columns in the results
set to be labelled with the column name, but will not distinguish
duplicates. So this will only work when there are no duplicates possible
in the results set.

To summarise, specify a column specifier array whenever there is any
uncertainty about which column could be from which table and only omit
it when every column name in the database metadata is unique.

All of the examples in the
<a href="/sdodasrel/examples.html" class="link">Examples</a> use a
column specifier. There is one example in the `Scenarios` directory of
the installation that does not: that which works with just the employee
table, and because it works with just one table, there can not exist
duplicate column names.

### 返回值

Returns a data graph. Specifically, it returns a root object of a
special type. Under this root object will be the data from the result
set. The root object will have a multi-valued containment property with
the same name as the application root type specified on the constructor,
and that property will contain one or more data objects of the
application root type.

In the event that the query returns no data, the special root object
will still be returned but the containment property for the application
root type will be empty.

### 错误／异常

<span class="function">SDO\_DAS\_Relational::executeQuery</span> can
throw an <span class="classname">SDO\_DAS\_Relational\_Exception</span>
if it is unable to construct the data graph correctly. This can occur
for a number of reasons: for example if it finds that it does not have
primary keys in the result set for all the objects. It also catches any
PDO exceptions and obtains PDO diagnostic information which it includes
in an <span class="classname">SDO\_DAS\_Relational\_Exception</span>
which it then throws.

### 范例

Please see the
<a href="/sdodasrel/examples.html" class="link">Examples</a> section in
the general information about the Relational DAS for many examples of
calling this method.

**目录**

-   [SDO\_DAS\_Relational::applyChanges](/ref/sdodasrel.html#SDO_DAS_Relational::applyChanges)
    — Applies the changes made to a data graph back to the database
-   [SDO\_DAS\_Relational::\_\_construct](/ref/sdodasrel.html#SDO_DAS_Relational::__construct)
    — Creates an instance of a Relational Data Access Service
-   [SDO\_DAS\_Relational::createRootDataObject](/ref/sdodasrel.html#SDO_DAS_Relational::createRootDataObject)
    — Returns the special root object in an otherwise empty data graph.
    Used when creating a data graph from scratch
-   [SDO\_DAS\_Relational::executePreparedQuery](/ref/sdodasrel.html#SDO_DAS_Relational::executePreparedQuery)
    — Executes an SQL query passed as a prepared statement, with a list
    of values to substitute for placeholders, and return the results as
    a normalised data graph
-   [SDO\_DAS\_Relational::executeQuery](/ref/sdodasrel.html#SDO_DAS_Relational::executeQuery)
    — Executes a given SQL query against a relational database and
    returns the results as a normalised data graph
